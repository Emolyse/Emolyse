<!DOCTYPE html>
<html lang="en">
<head>
    <title>three.js webgl - collada - skinning</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
        body {
            color: #000;
            font-family:Monospace;
            font-size:13px;
            text-align:center;

            background-color: #000;
            margin: 0px;
            overflow: hidden;
        }

        #info {
            position: absolute;
            top: 0px; width: 100%;
            padding: 5px;
        }

        a {

            color: #f00;
        }

        #jointTarget{
            position: fixed;
            background-color: #ff0000;
            z-index: 1000;
            width: 5%;
            height: 5%;
        }

        #console{
            display: none;
            position: fixed;
            background-color: #ffffff;
            color: #000000;
            z-index: 1000;
            width: 100%;
            text-align: center;
            height: 45px;
            padding-top: 5px;
            font-size: 30px;
            opacity: 0.8;
        }

    </style>
</head>
<body>
<div id="console"></div>
<div id="jointTarget"></div>
<div id="container"></div>

<script src="js/three.min.js"></script>
<script src="js/ColladaLoader.js"></script>
<script src="js/Detector.js"></script>
<script src="js/stats.min.js"></script>
<script src="js/jquery.min.js"></script>
<script>

    if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

    var container, stats;
    var camera, scene, renderer, backgroundScene, backgroundCamera, avatar;
    var clock = new THREE.Clock();

    init();

    function init() {

        container = document.getElementById( 'container' );


        var axeX, axeY, axeZ;

        var axeGenerator = function(x, y, z){
            var axeGeometry = new THREE.Geometry();
            axeGeometry.vertices.push(
                    new THREE.Vector3( 0, 0, 0 ),
                    new THREE.Vector3( x, y, z )
            );
            return axeGeometry;
        }

        var planeGenerator = function(width,height,color){
            var planeGeometry = new THREE.PlaneGeometry( width, height);
            var material = new THREE.MeshBasicMaterial( {color: color, wireframe:false} );
            return new THREE.Mesh( planeGeometry, material );
        };

        axeX = new THREE.Line(axeGenerator(100,0,0), new THREE.LineBasicMaterial({color:0xff0000}));
        axeY = new THREE.Line(axeGenerator(0,100,0), new THREE.LineBasicMaterial({color:0x00ff00}));
        axeZ = new THREE.Line(axeGenerator(0,0,100), new THREE.LineBasicMaterial({color:0x0000ff}));


        camera = new THREE.PerspectiveCamera( 25, window.innerWidth / window.innerHeight, 1, 1000 );
        camera.position.set( 1.5, 1.3, 7 );
        camera.lookAt( new THREE.Vector3(1.5,1.3,0));

        camera.up.x=0;
        camera.up.y=0;
        camera.up.z=0;

        scene = new THREE.Scene();
        scene.add(axeX);
        scene.add(axeY);
        scene.add(axeZ);

        var light = new THREE.DirectionalLight(0xF2D9B4,1.5);
        light.castShadow=true;
        light.position.set(1,2,3);
        light.lookAt(new THREE.Vector3(1,2,0));
        scene.add( light );
        renderer = new THREE.WebGLRenderer( { antialias: true } );
        renderer.setClearColor( 0xfff4e5 );
        renderer.setPixelRatio( window.devicePixelRatio );
        renderer.setSize( window.innerWidth, window.innerHeight );
        renderer.sortObjects = false;

        container.appendChild( renderer.domElement );
        stats = new Stats();
        stats.domElement.style.position = 'absolute';
        stats.domElement.style.top = '0px';


        container.appendChild( stats.domElement );
        /*
        * Bones :
        *    1 : buste
        *   12 : bras droit
        *   13: bras gauche
        */

        loadAvatar("male_caucasian.dae",function(){
            //On affiche la position des bones qui nous intéressent pour déterminer la position des points d'ancrages pour l'interaction tactile
            var idBones = [0,1,6,9,12,10,13];
            loadConsole("Height : 165.94");

        });

        var texture = THREE.ImageUtils.loadTexture( 'img/env.jpg' );
        var backgroundMesh = new THREE.Mesh(
                new THREE.PlaneGeometry(2, 2, 0),
                new THREE.MeshBasicMaterial({
                    map: texture
                }));

        backgroundMesh .material.depthTest = false;
        backgroundMesh .material.depthWrite = false;

        // Create your background scene
        backgroundScene = new THREE.Scene();
        backgroundCamera = new THREE.Camera();
        backgroundScene .add(backgroundCamera );
        backgroundScene .add(backgroundMesh);
        window.addEventListener( 'resize', onWindowResize, false );

        animate();

    }

    function onWindowResize() {

        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();

        renderer.setSize( window.innerWidth, window.innerHeight );

    }

    function animate() {

        requestAnimationFrame( animate, renderer.domElement );

        THREE.AnimationHandler.update( clock.getDelta() );

        renderer.autoClear = false;
        renderer.antialias=true;
        renderer.clear();
        renderer.render( backgroundScene, backgroundCamera);
        renderer.render( scene, camera );

        stats.update();

    }
    /*********************************
     * @description Load the .dae file according to the name et initialize it in the scene
     * @param name
     * @param callback
     */
    function loadAvatar(name,callback){
        var loader = new THREE.ColladaLoader();
        loader.load( "3D/dae/"+name, function (collada) {
            avatar = collada.skins[0];
            console.log(avatar);
            scene.add(collada.scene);
            var skeleton = avatar.skeleton;

                avatar.material.materials[6].shininess=0;

            // create a smooth skin
            // On active la manipulation des bones sur tous les matériaux qui composent un mesh
            for(var i=0;i<avatar.material.materials.length;i++){
                avatar.material.materials[i].skinning=true;
            }
            avatar.castShadow = true;
            avatar.receiveShadow= true;
            avatar.skeleton.useVertexTexture = false;

            //On redimensionne l'avatar pour qu'il soit adapté à l'environnement ces données pourront être stockée dans la BDD
            //Ici l'avatar occupe 82.5% de la hauteur de la fenêtre (top 11.5%; bot 6%)
            avatar.scale.set(1.5,1.5,1.5);

//            avatar.rotateX(THREE.Math.degToRad(90))
            avatar.rotateY(THREE.Math.degToRad(75));
//            avatar.position.set(0,0,0);
            skeleton.bones[12].rotateZ(THREE.Math.degToRad(30));
            skeleton.bones[12].rotateX(THREE.Math.degToRad(-15));
            skeleton.bones[13].rotateZ(THREE.Math.degToRad(-30));
            skeleton.bones[13].rotateX(THREE.Math.degToRad(-15));

            callback();
        } );
    }

    function loadConsole(msg){
        $("#console").text(msg);
    }
    var mouse = new THREE.Vector2();
    function onMouseDown(event){
        mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
        mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;
//        console.log(mouse);
        $("#jointTarget").css({
            left : event.clientX+"px",
            bottom :"auto",
            top : event.clientY+"px"
        });
    }
    container.addEventListener('mousedown', function (evt) {
        // The user has clicked; let's note this event
        // and the click's coordinates so that we can
        // react to it in the render loop
        clickInfo.userHasClicked = true;
        clickInfo.x = evt.clientX;
        clickInfo.y = evt.clientY;
    }, false);
//    var isMouseDown = false;
//    $("html, body").mousedown(event,function(event){
//        isMouseDown = true;
//        console.log("MouseDown");
//        console.log(event);
//        onMouseDown(event);
//    });
//    $("html, body").mouseup(event,function(event){
//        console.log("MouseUp");
//        isMouseDown = false;
//    });
//    $("html, body").mousemove(event,function(event){
//        if(isMouseDown) {
//            console.log(event);
//            onMouseDown(event);
//        }
//    });
</script>

</body>
</html>